<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Tomek Czajka">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Digit classifier - PyTorch lab</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">PyTorch lab</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../Tensors/" class="nav-link">Tensors</a>
                            </li>
                            <li class="nav-item">
                                <a href="./" class="nav-link active" aria-current="page">Digit classifier</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Tensors/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#lets-build-a-digit-classifier" class="nav-link">Let's build a digit classifier!</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#load-mnist-training-and-test-set" class="nav-link">Load MNIST training and test set</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#look-at-the-data" class="nav-link">Look at the data</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#visualize-using-matplotlib" class="nav-link">Visualize using matplotlib</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#dataloader" class="nav-link">DataLoader</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#feed-forward-neural-network" class="nav-link">Feed-Forward Neural Network</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#instantiate-the-model" class="nav-link">Instantiate the model</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#try-it-out" class="nav-link">Try it out</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#evaluate-the-model-on-test-data" class="nav-link">Evaluate the model on test data</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#train-digitclassfierff" class="nav-link">Train DigitClassfierFF</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#visualize-training-progress" class="nav-link">Visualize training progress</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#try-it-out-again" class="nav-link">Try it out again</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#inspect-first-layer-weights" class="nav-link">Inspect first layer weights</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#convolutional-neural-network" class="nav-link">Convolutional Neural Network</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#try-out-untrained-cnn" class="nav-link">Try out untrained CNN</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#train-cnn" class="nav-link">Train CNN</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#try-out-trained-cnn" class="nav-link">Try out trained CNN</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="lets-build-a-digit-classifier">Let's build a digit classifier!</h1>
<h1 id="load-mnist-training-and-test-set">Load MNIST training and test set</h1>
<pre><code class="language-python">import torch
from torchvision import datasets
from torchvision.transforms import ToTensor

training_data = datasets.MNIST(
    'data/',
    train = True,
    transform = ToTensor(),
    download = True)

test_data = datasets.MNIST(
    'data/',
    train = False,
    transform = ToTensor(),
    download = True)

print(len(training_data), len(test_data))
</code></pre>
<h1 id="look-at-the-data">Look at the data</h1>
<pre><code class="language-python">(image, label) = training_data[0]
print(image)
print(image.shape)
print(label)
</code></pre>
<h1 id="visualize-using-matplotlib">Visualize using matplotlib</h1>
<pre><code class="language-python">import random
from matplotlib import pyplot

(image, label) = random.choice(training_data)
pyplot.imshow(image[0])
print(label)
</code></pre>
<h1 id="dataloader">DataLoader</h1>
<pre><code class="language-python">
from torch.utils.data import DataLoader

train_dataloader = DataLoader(training_data, batch_size=16, shuffle=True)

for (index, (features, labels)) in enumerate(train_dataloader):
    if index == 10: break
    print(features.shape, features.dtype)
    print(labels)
</code></pre>
<h1 id="feed-forward-neural-network">Feed-Forward Neural Network</h1>
<pre><code class="language-python">from torch import nn

class DigitClassifierFF(nn.Module):
    def __init__(self):
        super().__init__()
        self.num_hidden = 8
        # layers with weights
        self.layers = nn.Sequential(
            nn.Flatten(1),
            # 28 * 28 * 8 = 6272
            nn.Linear(28 * 28, self.num_hidden),
            nn.ReLU(),
            nn.Linear(self.num_hidden, 10),
            nn.LogSoftmax(dim=1))

    # input: [N, 1, 28, 28]
    def forward(self, input):
        log_prob = self.layers(input)
        return log_prob
</code></pre>
<h2 id="instantiate-the-model">Instantiate the model</h2>
<pre><code class="language-python">digit_classifier_ff = DigitClassifierFF()
</code></pre>
<h2 id="try-it-out">Try it out</h2>
<pre><code class="language-python">import torch
import random
from matplotlib import pyplot

def visualize(model, data):
    (image, correct_label) = random.choice(test_data)
    # image: 1 x 28 x 28
    print(f'Correct answer: {correct_label}')
    log_prob = model(image.reshape(1, 1, 28, 28))
    # log_prob: 1 x 10
    prob = log_prob[0].exp().tolist()
    fig, axes = pyplot.subplots(1, 2, figsize=(12, 5))
    axes[0].imshow(image[0])
    axes[1].bar(list(range(10)), prob)
    pyplot.show()
</code></pre>
<pre><code class="language-python">visualize(digit_classifier_ff, test_data)
</code></pre>
<h2 id="evaluate-the-model-on-test-data">Evaluate the model on test data</h2>
<pre><code class="language-python">from torch.utils.data import DataLoader

def evaluate(model, data):
    cost_fn = nn.NLLLoss()
    data_loader = DataLoader(data, batch_size = 32)
    cost = 0.0
    correct = 0
    with torch.no_grad():
        for (images, correct_labels) in data_loader:
            log_prob = model(images)
            cost += len(images) * cost_fn(log_prob, correct_labels).item()
            correct += (log_prob.argmax(dim=1) == correct_labels).sum().item()
    cost /= len(data)
    correct /= len(data)
    print(f'Evaluation cost: {cost:.8f} correct: {100 * correct:.2f}%')
    return cost
</code></pre>
<pre><code class="language-python">evaluate(digit_classifier_ff, test_data)
</code></pre>
<h3 id="base-cost-for-random-guessing">Base cost for random guessing</h3>
<pre><code class="language-python">torch.tensor(10.0).log()
</code></pre>
<h2 id="train-digitclassfierff">Train DigitClassfierFF</h2>
<pre><code class="language-python">from torch import optim

def training_epoch(model, data):
    cost_fn = nn.NLLLoss()
    data_loader = DataLoader(data, batch_size=32, shuffle=True)
    optimizer = optim.AdamW(model.parameters(), lr = 0.001)
    total_cost = 0.0
    for (images, labels) in data_loader:
        log_prob = model(images)
        cost = cost_fn(log_prob, labels)
        total_cost += len(images) * cost.item()
        # backpropagation
        optimizer.zero_grad()
        cost.backward()
        optimizer.step()
    total_cost /= len(data)
    print(f'Training cost: {total_cost:.8f}')
    return total_cost
</code></pre>
<pre><code class="language-python">def train(model):
    training_costs = []
    validation_costs = []
    for epoch in range(10):
        training_cost = training_epoch(model, training_data)
        validation_cost = evaluate(model, test_data)
        training_costs.append(training_cost)
        validation_costs.append(validation_cost)
    return training_costs, validation_costs
</code></pre>
<pre><code class="language-python">digit_classifier_ff = DigitClassifierFF()
training_costs, validation_costs = train(digit_classifier_ff)
</code></pre>
<h2 id="visualize-training-progress">Visualize training progress</h2>
<pre><code class="language-python">def visualize_cost(training_costs, validation_costs):
    pyplot.plot(range(len(training_costs)), training_costs, label = 'training')
    pyplot.plot(range(len(validation_costs)), validation_costs, label = 'validation')
    pyplot.legend()
    pyplot.show()
</code></pre>
<pre><code class="language-python">visualize_cost(training_costs, validation_costs)
</code></pre>
<h2 id="try-it-out-again">Try it out again</h2>
<pre><code class="language-python">visualize(digit_classifier_ff, test_data)
</code></pre>
<h2 id="inspect-first-layer-weights">Inspect first layer weights</h2>
<pre><code class="language-python">print(digit_classifier_ff.layers[1])
</code></pre>
<pre><code class="language-python">print(digit_classifier_ff.layers[1].weight.shape)
</code></pre>
<pre><code class="language-python">index = 7
image = digit_classifier_ff.layers[1].weight[index].detach().reshape(28, 28)
print(image.min(), image.max())
pyplot.imshow(image)
</code></pre>
<hr />
<h1 id="convolutional-neural-network">Convolutional Neural Network</h1>
<pre><code class="language-python">class DigitClassifierCNN(nn.Module):
    def __init__(self):
        super().__init__()
        self.channels_1 = 8
        self.channels_2 = 8
        self.channels_3 = 8
        self.num_hidden = 16
        self.layers = nn.Sequential(
            # 5^2 * 1 * 8 = 200 params
            nn.Conv2d(1, self.channels_1, 5, padding='same'),
            # N x 14 x 14 x 8
            nn.MaxPool2d(2),
            nn.ReLU(),
            # 5^2 * 8 * 8 = 1600 params
            nn.Conv2d(self.channels_1, self.channels_2, 5, padding='same'),
            # N x 7 x 7 x 8
            nn.MaxPool2d(2),
            nn.ReLU(),
            # 5^2 * 8 * 8 = 1600 params
            nn.Conv2d(self.channels_2, self.channels_3, 5, padding='same'),
            # N x 4 x 4 x 8
            nn.MaxPool2d(2, ceil_mode=True),
            nn.ReLU(),
            # N x 128
            nn.Flatten(1),
            # 128 * 16 = 1024 params
            nn.Linear(4 * 4 * self.channels_3, self.num_hidden),
            nn.ReLU(),
            # 16 * 10 = 160 params
            nn.Linear(self.num_hidden, 10),
            nn.LogSoftmax(dim=1))

    # input: [N, 1, 28, 28]
    def forward(self, input):
        log_prob = self.layers(input)
        return log_prob
</code></pre>
<h2 id="try-out-untrained-cnn">Try out untrained CNN</h2>
<pre><code class="language-python">digit_classifier_cnn = DigitClassifierCNN()
</code></pre>
<pre><code class="language-python">visualize(digit_classifier_cnn, test_data)
</code></pre>
<pre><code class="language-python">evaluate(digit_classifier_cnn, test_data)
</code></pre>
<h2 id="train-cnn">Train CNN</h2>
<pre><code class="language-python">digit_classifier_cnn = DigitClassifierCNN()
training_costs, validation_costs = train(digit_classifier_cnn)
</code></pre>
<pre><code class="language-python">visualize_cost(training_costs, validation_costs)
</code></pre>
<h2 id="try-out-trained-cnn">Try out trained CNN</h2>
<pre><code class="language-python">visualize(digit_classifier_cnn, test_data)
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
